<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Monitoring Progres KK- BOS Belanja Modal</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Google Chart -->
<script src="https://www.gstatic.com/charts/loader.js"></script>

<!-- Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
.kecamatan { cursor:pointer; color:#2563eb; }

.progress-red { color:#dc2626; }
.progress-yellow { color:#ca8a04; }
.progress-green { color:#16a34a; }

.progress-bar-red { background:#dc2626; }
.progress-bar-yellow { background:#facc15; }
.progress-bar-green { background:#16a34a; }

/* CENTER CELL */
.tengah {
 text-align: center;
 vertical-align: middle;
}

/* BAR HORIZONTAL REKAP */
.progress-rekap {
 height: 18px;
 background-color: #e5e7eb;
 border-radius: 4px;
 overflow: hidden;
}
.progress-rekap-inner {
 height: 100%;
 text-align: center;
 color: #fff;
 line-height: 18px;
 font-size: 0.75rem;
}

/* MOBILE */
@media (max-width:768px){
 th,td { font-size:0.75rem; }
 h2 { font-size:1rem; }
}
</style>
</head>

<body class="bg-gray-100 p-1 md:p-4">

<div class="container bg-white shadow rounded p-2 md:p-3">

<h2 class="font-bold mb-2 text-center md:text-left">
ðŸ“Š Dashboard Monitoring Progres KK- BOS Belanja Modal
</h2>

<!-- FILTER LAYER & STATUS -->
<div class="flex flex-wrap justify-center md:justify-start gap-2 mb-3">
<button class="btn btn-outline-primary btn-sm active" onclick="setLayer('ALL',this)">SEMUA</button>
<button class="btn btn-outline-primary btn-sm" onclick="setLayer('SD',this)">SD</button>
<button class="btn btn-outline-primary btn-sm" onclick="setLayer('SMP',this)">SMP</button>

<select class="form-select form-select-sm w-auto" onchange="filterStatus(this.value)">
  <option value="ALL">Semua Status</option>
  <option value="0">0%</option>
  <option value="33">33%</option>
  <option value="67">67%</option>
  <option value="100">100%</option>
</select>
</div>

<!-- CHART -->
<div id="chartKecamatan" class="w-full h-[250px] md:h-[300px]"></div>

<!-- REKAP -->
<div class="table-responsive mt-2">
<table class="table table-bordered table-sm">
<thead class="table-dark">
<tr>
<th>Kecamatan</th>
<th>Jumlah</th>
<th>Progres</th>
<th>Keterangan</th>
</tr>
</thead>
<tbody id="rekapKecamatan"></tbody>
</table>
</div>

<hr class="my-2">

<!-- HEADER SEKOLAH -->
<div class="flex flex-col md:flex-row md:justify-between gap-2 mb-2">
<h3 id="judulSekolah" class="font-bold text-sm md:text-lg text-center md:text-left">
Daftar Sekolah
</h3>

<div class="flex gap-1 justify-center md:justify-end">
<input type="text" id="searchInput" class="form-control form-control-sm"
 placeholder="Cari sekolah / NPSN" onkeyup="searchSekolah()">
<button class="btn btn-success btn-sm" onclick="exportExcel()">Excel</button>
<button class="btn btn-danger btn-sm" onclick="exportPDF()">PDF</button>
</div>
</div>

<!-- TABEL SEKOLAH -->
<div class="table-responsive">
<table class="table table-bordered table-hover table-sm">
<thead class="table-secondary">
<tr>
<th>No</th>
<th>NPSN</th>
<th>Nama</th>
<th>Kelurahan</th>
<th>INPUT KERTAS KERJA</th>
<th>INPUT E-BMD</th>
<th>APLOUD DOKUMEN</th>
<th>STATUS</th>
<th>%</th>
</tr>
</thead>
<tbody id="tabelSekolah"></tbody>
</table>
</div>

<!-- PAGINATION -->
<nav>
<ul class="pagination pagination-sm justify-content-center" id="pagination"></ul>
</nav>

</div>

<script>
google.charts.load('current', {'packages':['corechart']});
google.charts.setOnLoadCallback(loadData);

const sheetURL =
"https://docs.google.com/spreadsheets/d/1B8VixaZ5vbe3naEy-uQPWdisGl1rHEYRqlPqIcIhNJ4/gviz/tq?sheet=Sheet1";

let allData=[], layerData=[], filteredData=[];
let currentLayer='ALL', currentStatus='ALL', currentPage=1;
const rowsPerPage=8;

/* HITUNG PROGRES */
function hitungProgres(r){
 let t=0;
 if(r[7]===true) t++;
 if(r[8]===true) t++;
 if(r[9]===true) t++;
 return Math.round((t/3)*100);
}

function warna(p){
 if(p>=80) return 'green';
 if(p>=50) return 'yellow';
 return 'red';
}

function keterangan(p){
 if(p===100) return 'Selesai';
 if(p>=67) return 'Sebagian';
 if(p>=33) return 'Sedikit';
 return 'Belum Mulai';
}

/* LOAD DATA */
function loadData(){
 fetch(sheetURL).then(r=>r.text()).then(t=>{
  const j=JSON.parse(t.substr(47).slice(0,-2));
  allData=j.table.rows.map(r=>r.c.map(c=>c?c.v:""));
  applyLayer();
 });
}

/* FILTER LAYER */
function setLayer(l,b){
 currentLayer=l;
 document.querySelectorAll('.btn-outline-primary')
  .forEach(x=>x.classList.remove('active'));
 b.classList.add('active');
 applyLayer();
}

function filterStatus(s){
 currentStatus = s;
 applyLayer();
}

/* APPLY LAYER & STATUS FILTER */
function applyLayer(){
 layerData=currentLayer==='ALL'
  ? allData
  : allData.filter(r=>String(r[2]).toUpperCase().includes(currentLayer));

 if(currentStatus !== 'ALL'){
   layerData = layerData.filter(r => {
     const p = hitungProgres(r);
     if(currentStatus == '33') return p>=33 && p<67;
     if(currentStatus == '67') return p>=67 && p<100;
     return p==parseInt(currentStatus);
   });
 }

 buatRekap();
 drawChart();
 document.getElementById("tabelSekolah").innerHTML="";
}

/* REKAP */
function buatRekap(){
 const m={};
 layerData.forEach(r=>{
  const k=r[6], p=hitungProgres(r);
  if(!m[k]) m[k]={t:0,s:0};
  m[k].t++; m[k].s+=p;
 });
 const tb=document.getElementById("rekapKecamatan");
 tb.innerHTML="";
 Object.keys(m).forEach(k=>{
  const avg=Math.round(m[k].s/m[k].t);
  const barColor = warna(avg);
  tb.innerHTML+=`
  <tr>
   <td class="kecamatan" onclick="tampilSekolah('${k}')">${k}</td>
   <td class="tengah">${m[k].t}</td>
   <td class="tengah progress-${barColor}">${avg}%</td>
   <td>
     <div class="progress-rekap">
       <div class="progress-rekap-inner progress-bar-${barColor}" style="width:${avg}%">
         ${avg===0?'':keterangan(avg)}
       </div>
     </div>
   </td>
  </tr>`;
 });
}

/* CHART */
function drawChart(){
 const d=new google.visualization.DataTable();
 d.addColumn('string','Kecamatan');
 d.addColumn('number','Progres');
 const m={};
 layerData.forEach(r=>{
  const k=r[6], p=hitungProgres(r);
  if(!m[k]) m[k]={t:0,s:0};
  m[k].t++; m[k].s+=p;
 });
 Object.keys(m).forEach(k=>d.addRow([k,m[k].s/m[k].t]));
 new google.visualization.ColumnChart(chartKecamatan)
 .draw(d,{legend:'none',colors:['#2563eb']});
}

/* TABEL SEKOLAH */
function tampilSekolah(k){
 filteredData=layerData.filter(r=>r[6]==k);
 currentPage=1;
 renderTable();
}

function renderTable(){
 const start=(currentPage-1)*rowsPerPage;
 const data=filteredData.slice(start,start+rowsPerPage);
 const tb=document.getElementById("tabelSekolah");
 tb.innerHTML="";
 data.forEach(r=>{
  const p=hitungProgres(r);
  const w=warna(p);
  tb.innerHTML+=`
  <tr>
   <td class="tengah">${r[0]}</td>
   <td class="tengah">${r[1]}</td>
   <td>${r[2]}</td>
   <td>${r[4]}</td>
   <td class="tengah">${r[7]?'âœ”':''}</td>
   <td class="tengah">${r[8]?'âœ”':''}</td>
   <td class="tengah">${r[9]?'âœ”':''}</td>
   <td class="align-middle">${keterangan(p)}</td>
   <td class="tengah progress-${w}">${p}%</td>
  </tr>`;
 });
 renderPagination();
}

/* PAGINATION */
function renderPagination(){
 const p=document.getElementById("pagination");
 p.innerHTML="";
 const t=Math.ceil(filteredData.length/rowsPerPage);
 for(let i=1;i<=t;i++){
  p.innerHTML+=`
  <li class="page-item ${i===currentPage?'active':''}">
   <a class="page-link" href="#" onclick="currentPage=${i};renderTable()">${i}</a>
  </li>`;
 }
}

/* SEARCH */
function searchSekolah(){
 const q=document.getElementById("searchInput").value.toLowerCase();
 filteredData=layerData.filter(r=>
  r[2].toLowerCase().includes(q) || String(r[1]).includes(q)
 );
 currentPage=1;
 renderTable();
}

/* EXPORT */
function exportExcel(){
 XLSX.writeFile(
  XLSX.utils.table_to_book(document.querySelector("table")),
  'sekolah.xlsx'
 );
}
function exportPDF(){
 html2pdf().from(document.querySelector(".container"))
 .set({margin:5,filename:'laporan.pdf'}).save();
}
</script>

</body>
</html>
