<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Monitoring Aset BOS</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
th, td { border:1px solid #e5e7eb; padding:4px; font-size:11px; }
thead th { background:#001f3f; color:#fff; }
</style>
</head>

<body class="p-4 bg-slate-100">

<h1 class="text-center font-bold text-xl mb-4">
ðŸ“Š RINCIAN BELANJA MODAL BOS 2025
</h1>

<div class="flex gap-2 mb-3">
  <input id="searchInput" onkeyup="updateTable()"
    class="border px-3 py-2 flex-1 rounded"
    placeholder="Cari sekolah / kecamatan">

  <select id="filterJenjang" onchange="loadData()" class="border px-3 py-2 rounded">
    <option value="ALL">Semua Jenjang</option>
    <option value="SD">SD</option>
    <option value="SMP">SMP</option>
  </select>

  <button onclick="exportPDFMain()" class="bg-red-600 text-white px-4 rounded">
    PDF Tabel Utama
  </button>
</div>

<!-- TABEL UTAMA -->
<div class="bg-white rounded shadow overflow-auto">
<table id="mainTable" class="w-full">
<thead>
<tr>
  <th>No</th>
  <th>Kecamatan</th>
  <th>Sekolah</th>
  <th>Peralatan & Mesin</th>
  <th>Aset Tetap Lain</th>
  <th>Total Rekon</th>
  <th>Total E-BMD</th>
  <th>Selisih</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

<!-- PAGINATION UTAMA -->
<div class="flex justify-between items-center mt-2">
  <select id="pageSize" onchange="changePageSize()" class="border px-2 py-1 rounded text-xs">
    <option value="10">10</option>
    <option value="25">25</option>
    <option value="50">50</option>
  </select>

  <div class="flex gap-1 items-center">
    <button onclick="prevPage()" class="px-2 border rounded">â—€</button>
    <span id="pageInfo" class="text-xs"></span>
    <button onclick="nextPage()" class="px-2 border rounded">â–¶</button>
  </div>
</div>

<!-- MODAL DETAIL -->
<div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center">
  <div class="bg-white w-11/12 md:w-3/4 rounded p-4">
    <div class="flex justify-between mb-2">
      <h2 id="modalTitle" class="font-bold"></h2>
      <div class="flex gap-2">
        <button onclick="exportPDFDetailOfficial()" class="bg-blue-600 text-white px-2 rounded text-xs">
          PDF Detail
        </button>
        <button onclick="closeModal()">âœ–</button>
      </div>
    </div>

    <table class="w-full text-xs">
      <thead class="bg-slate-200">
        <tr>
          <th>Judul</th>
          <th>Kode Aset</th>
          <th>Jumlah</th>
          <th>Harga</th>
          <th>Total</th>
          <th>Asal</th>
          <th>Keterangan</th>
        </tr>
      </thead>
      <tbody id="detailBody"></tbody>
    </table>

    <!-- PAGINATION DETAIL -->
    <div class="flex justify-end gap-2 mt-2">
      <button onclick="prevDetailPage()" class="px-2 border rounded text-xs">â—€</button>
      <span id="detailPageInfo" class="text-xs"></span>
      <button onclick="nextDetailPage()" class="px-2 border rounded text-xs">â–¶</button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL="https://script.google.com/macros/s/AKfycbxbJ4Y1V30BynuGIHbEeelEB7hN1xqrNtvKMcXIewzeBd_ZLTw5s-c6qDJhd3-keRJm/exec";

let masterData=[]; 
let currentPage=1; 
let pageSize=10;

let detailData=[]; 
let detailPage=1; 
const detailPageSize=10;

let currentSekolah = ""; // nama sekolah aktif

const rupiah=v=>new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(v||0);

async function loadData(){
  const jenjang=document.getElementById('filterJenjang').value;
  const res=await fetch(`${SCRIPT_URL}?jenjang=${jenjang}`);
  masterData=await res.json();
  currentPage=1;
  updateTable();
}

function updateTable(){
  const q=searchInput.value.toLowerCase();
  tableBody.innerHTML="";

  const filtered=masterData.filter(r=>(r[0]+" "+r[1]).toLowerCase().includes(q));
  const totalPages=Math.ceil(filtered.length/pageSize)||1;
  if(currentPage>totalPages) currentPage=totalPages;
  const start=(currentPage-1)*pageSize;
  const pageData=filtered.slice(start,start+pageSize);
  let no=start+1;

  pageData.forEach(r=>{
    const sel=r[4]-r[5];
    const tr=document.createElement("tr");
    if(Math.abs(sel)>1) tr.classList.add("bg-red-50");

    [no++, r[0], r[1], rupiah(r[2]), rupiah(r[3]), rupiah(r[4]), rupiah(r[5]), rupiah(sel)].forEach((v,i)=>{
      const td=document.createElement("td");
      td.textContent=v;
      if(i===2){ td.onclick=()=>showDetail(r[1]); td.classList.add("text-blue-600","underline","cursor-pointer"); }
      if(i===7){ td.classList.add(sel!==0?"text-red-600":"text-emerald-600","font-bold"); }
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });

  pageInfo.textContent=`Halaman ${currentPage} / ${totalPages}`;
}

function nextPage(){currentPage++; updateTable();}
function prevPage(){if(currentPage>1) currentPage--; updateTable();}
function changePageSize(){pageSize=Number(pageSize.value||pageSize); currentPage=1; updateTable();}

// --- DETAIL ---
async function showDetail(sekolah){
  currentSekolah = sekolah; // simpan nama sekolah
  modal.classList.remove("hidden"); 
  modal.classList.add("flex");
  modalTitle.textContent="Detail Aset - "+sekolah;

  const res=await fetch(`${SCRIPT_URL}?mode=detail&sekolah=${encodeURIComponent(sekolah)}`);
  detailData=await res.json(); 
  detailPage=1; 
  renderDetailPage();
}

function renderDetailPage(){
  detailBody.innerHTML="";
  const totalPages=Math.ceil(detailData.length/detailPageSize)||1;
  const start=(detailPage-1)*detailPageSize;
  const pageData=detailData.slice(start,start+detailPageSize);

  pageData.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach((v,i)=>{
      const td=document.createElement("td");
      // Jumlah (i=2) tetap angka, Harga & Total (i=3,4) pakai Rupiah
      if(i===3||i===4) td.textContent = rupiah(v);
      else td.textContent = v;
      tr.appendChild(td);
    });
    detailBody.appendChild(tr);
  });
  detailPageInfo.textContent=`Halaman ${detailPage} / ${totalPages}`;
}

function nextDetailPage(){detailPage++; renderDetailPage();}
function prevDetailPage(){if(detailPage>1) detailPage--; renderDetailPage();}
function closeModal(){modal.classList.add("hidden");}

// --- EXPORT PDF TABEL UTAMA ---
function exportPDFMain(){
  const { jsPDF } = window.jspdf; 
  const doc=new jsPDF('l','mm','a4');
  doc.setFontSize(14); doc.text("PEMERINTAH KABUPATEN DONGGALA",148,12,{align:'center'});
  doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN",148,18,{align:'center'}); 
  doc.line(10,22,287,22);
  doc.setFontSize(11); doc.text("LAPORAN MONITORING ASET BOS 2025",148,30,{align:'center'});
  doc.autoTable({html:'#mainTable', startY:35, styles:{fontSize:7}});
  doc.save("Monitoring_Aset_BOS_2025.pdf");
}

// --- EXPORT PDF DETAIL RESMI ---
function exportPDFDetailOfficial(){
  if(detailData.length===0) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','mm','a4');

  // pakai variabel global currentSekolah
  const sekolahName = currentSekolah;

  // Logo
  const logoKabupaten = "https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png";
  const logoDinas = "https://www.freepnglogos.com/uploads/tut-wuri-handayani-png-logo/vector-wuri-handayani-warna-0.png";

  doc.addImage(logoKabupaten,'PNG',12,8,20,20);
  doc.addImage(logoDinas,'PNG',257,8,20,20);

  doc.setFontSize(16); doc.text("PEMERINTAH KABUPATEN DONGGALA",148,12,{align:'center'});
  doc.setFontSize(14); doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN",148,20,{align:'center'});
  doc.setLineWidth(0.8); doc.line(10,25,287,25);
  doc.setFontSize(12); doc.text("RINCIAN BELANJA MODAL ASET SEKOLAH",148,32,{align:'center'});
  doc.text(sekolahName,148,38,{align:'center'});

  let startY=45; 
  const pageSizePDF=15;

  for(let i=0;i<detailData.length;i+=pageSizePDF){
    const pageData=detailData.slice(i,i+pageSizePDF);
    const rows=pageData.map(r=>r.map((v,idx)=>(idx===3||idx===4)?rupiah(v):v));
    doc.autoTable({
      head:[["Judul","Kode Aset","Jumlah","Harga","Total","Asal","Keterangan"]],
      body:rows,
      startY:startY,
      styles:{fontSize:8,cellPadding:2},
      headStyles:{fillColor:[0,31,63],textColor:255,halign:'center'},
      alternateRowStyles:{fillColor:[240,240,240]},
      theme:'grid'
    });
    if(i+pageSizePDF<detailData.length) doc.addPage();
    startY=20;
  }

  doc.save(`Rincian_Aset_${sekolahName}.pdf`);
}

window.onload=loadData;
</script>

</body>
</html>
