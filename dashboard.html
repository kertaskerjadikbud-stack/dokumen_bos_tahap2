<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Monitoring Belanja Modal BOS 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --dark-blue: #001f4d; --gold: #ffd700; --soft-bg: #f4f7f6; }
        body { background: var(--soft-bg); font-family: 'Segoe UI', sans-serif; font-size: 14px; }
        
        /* Header Responsive */
        .header-panel { background: var(--dark-blue); color: white; border-bottom: 4px solid var(--gold); padding: 1rem 0; }
        .text-gold { color: var(--gold) !important; }

        /* Stats Cards */
        .stat-box { border-radius: 12px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.08); background: white; margin-bottom: 10px; }
        .stat-title { font-size: 0.7rem; font-weight: bold; color: #6c757d; text-transform: uppercase; display: block; }
        .stat-value { font-size: 1.1rem; font-weight: bold; margin-bottom: 0; color: #212529; }
        .grand-total-box { background: #e9ecef; border-top: 4px solid #198754 !important; }

        /* Table & Layout */
        .table-res { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .badge-sd { background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        .badge-smp { background-color: #0d6efd; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header-panel h3 { font-size: 1.2rem; text-align: center; }
            .header-panel p { font-size: 0.8rem; text-align: center; }
            .header-panel .d-flex { flex-direction: column; gap: 10px !important; align-items: center !important; }
            .stat-value { font-size: 1rem; }
            .btn-sm { width: 100%; } /* Tombol jadi full width di HP */
            .filter-area { flex-direction: column; align-items: stretch !important; }
            .filter-area > * { width: 100% !important; }
            .hide-mobile { display: none; } /* Sembunyikan kolom kurang penting di HP */
        }

        @media print {
            @page { size: landscape; margin: 1cm; }
            .btn, .filter-area, .pagination-container, .chart-container { display: none !important; }
            .header-panel { background: white !important; color: black !important; border-bottom: 2px solid black; }
            .stat-box { border: 1px solid #ccc !important; box-shadow: none !important; }
            .hide-mobile { display: table-cell !important; }
        }
    </style>
</head>
<body>

<div class="header-panel mb-3">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="text-center text-md-start">
            <h3 class="fw-bold mb-0 text-gold">DASHBOARD BELANJA MODAL BOS</h3>
            <p class="mb-0 opacity-75">DINAS PENDIDIKAN DAN KEBUDAYAAN - 2025</p>
        </div>
        <div class="d-flex gap-2 w-100 w-md-auto">
            <button class="btn btn-light btn-sm fw-bold" onclick="exportToExcel()">üìä EXCEL</button>
            <button class="btn btn-danger btn-sm fw-bold" onclick="printToPDF()">üñ®Ô∏è PDF</button>
            <button class="btn btn-warning btn-sm fw-bold" onclick="fetchData()">üîÑ REFRESH</button>
        </div>
    </div>
</div>

<div class="container-fluid container-md">
    <div class="row g-2 mb-2">
        <div class="col-md-6">
            <div class="card stat-box border-start border-4 border-danger p-3">
                <h6 class="fw-bold text-danger border-bottom pb-2 mb-2" style="font-size: 0.8rem;">JENJANG SD</h6>
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <span class="stat-title">Peralatan</span>
                        <p id="sd-mesin" class="stat-value text-nowrap">Rp 0</p>
                    </div>
                    <div class="col-6">
                        <span class="stat-title">Lainnya</span>
                        <p id="sd-lain" class="stat-value text-nowrap">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card stat-box border-start border-4 border-primary p-3">
                <h6 class="fw-bold text-primary border-bottom pb-2 mb-2" style="font-size: 0.8rem;">JENJANG SMP</h6>
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <span class="stat-title">Peralatan</span>
                        <p id="smp-mesin" class="stat-value text-nowrap">Rp 0</p>
                    </div>
                    <div class="col-6">
                        <span class="stat-title">Lainnya</span>
                        <p id="smp-lain" class="stat-value text-nowrap">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-12">
            <div class="card stat-box grand-total-box p-3">
                <h6 class="fw-bold text-dark border-bottom border-secondary pb-2 mb-3 text-center" style="font-size: 0.8rem;">REKAPITULASI TOTAL (SD + SMP)</h6>
                <div class="row text-center g-2">
                    <div class="col-6 col-md-4 border-end-md">
                        <span class="stat-title">Total Peralatan</span>
                        <p id="total-mesin" class="stat-value text-dark">Rp 0</p>
                    </div>
                    <div class="col-6 col-md-4 border-end-md">
                        <span class="stat-title">Total Lainnya</span>
                        <p id="total-lain" class="stat-value text-dark">Rp 0</p>
                    </div>
                    <div class="col-12 col-md-4">
                        <span class="stat-title text-success">Grand Total</span>
                        <p id="grand-total" class="stat-value text-success fs-4">Rp 0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card stat-box p-2 mb-3 chart-container">
        <div style="height: 200px;"><canvas id="assetChart"></canvas></div>
    </div>

    <div class="table-res">
        <div class="p-3 bg-white border-bottom filter-area d-flex flex-wrap gap-2 align-items-center">
            <select id="filterJenjang" class="form-select form-select-sm" onchange="currentPage=1; renderUI()">
                <option value="">Semua Jenjang</option>
                <option value="SD">SD</option>
                <option value="SMP">SMP</option>
            </select>
            <select id="filterKecamatan" class="form-select form-select-sm" onchange="currentPage=1; renderUI()"></select>
            <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="Cari Nama Sekolah..." oninput="currentPage=1; renderUI()">
            <select id="rowLimit" class="form-select form-select-sm" onchange="currentPage=1; renderUI()">
                <option value="10">10 Baris</option>
                <option value="50">50 Baris</option>
                <option value="500">Semua</option>
            </select>
        </div>
        
        <div class="table-responsive">
            <table id="targetTable" class="table table-sm table-hover align-middle mb-0" style="min-width: 800px;">
                <thead class="table-dark text-center">
                    <tr>
                        <th style="width: 40px;">No</th>
                        <th>Kecamatan</th>
                        <th style="width: 60px;">Jenjang</th>
                        <th>Nama Sekolah</th>
                        <th>Rekening Belanja</th>
                        <th class="hide-mobile">Kodefikasi Aset</th>
                        <th class="text-end">Jumlah</th>
                    </tr>
                </thead>
                <tbody id="main-table"></tbody>
            </table>
        </div>

        <div class="pagination-container d-flex flex-column flex-md-row justify-content-between align-items-center p-3 gap-2 bg-light">
            <div id="pageInfo" class="small fw-bold text-muted"></div>
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item"><button class="page-link" onclick="changePage(-1)">¬´</button></li>
                    <li class="page-item"><button class="page-link" onclick="changePage(1)">¬ª</button></li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyuo6OM5IE5sVzA4BpRAU5fWvsy72oc3pFaE2LcVo2PzEd-d7XaO6tzcfqq01UU0GMP/exec";
    let masterData = [];
    let filteredData = []; 
    let currentPage = 1;
    let myChart = null;
    let isPrinting = false;

    const formatIDR = (num) => num.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    async function fetchData() {
        try {
            const response = await fetch(`${SCRIPT_URL}?action=readData`);
            const result = await response.json();
            if (result.success) {
                masterData = result.data;
                populateKecamatanFilter();
                renderUI();
            }
        } catch (error) {
            document.getElementById("main-table").innerHTML = '<tr><td colspan="7" class="text-center p-4">Koneksi Gagal.</td></tr>';
        }
    }

    function populateKecamatanFilter() {
        const kecSet = new Set();
        masterData.forEach(row => { if(row[1]) kecSet.add(row[1].trim().toUpperCase()); });
        const select = document.getElementById("filterKecamatan");
        select.innerHTML = '<option value="">Semua Kecamatan</option>';
        Array.from(kecSet).sort().forEach(kec => {
            select.innerHTML += `<option value="${kec}">${kec}</option>`;
        });
    }

    function renderUI() {
        const selectedKec = document.getElementById("filterKecamatan").value;
        const selectedJenjang = document.getElementById("filterJenjang").value;
        const searchKeyword = document.getElementById("searchInput").value.toUpperCase();
        const rowLimit = parseInt(document.getElementById("rowLimit").value);
        
        let grouped = {};
        let stats = { sd_mesin: 0, sd_lain: 0, smp_mesin: 0, smp_lain: 0 };
        let rekapKec = {};

        masterData.forEach(row => {
            const kec = (row[1] || "TANPA KECAMATAN").trim().toUpperCase();
            const unit = (row[2] || "Tanpa Nama").trim();
            const rekM = (row[12] || "-").toString().trim(); 
            const kodeAset = (row[13] || "-").toString().trim(); 
            const nilai = Number(row[18]) || 0; 
            const unitUpper = unit.toUpperCase();
            const jenjang = (unitUpper.includes("SDN") || unitUpper.includes("SD NEGERI") || unitUpper.includes(" SD ")) ? "SD" : "SMP";

            const isMesin = rekM.toUpperCase().includes("PERALATAN DAN MESIN");
            if (jenjang === "SD") {
                isMesin ? stats.sd_mesin += nilai : stats.sd_lain += nilai;
            } else {
                isMesin ? stats.smp_mesin += nilai : stats.smp_lain += nilai;
            }

            if (selectedKec && kec !== selectedKec) return;
            if (selectedJenjang && jenjang !== selectedJenjang) return;
            if (searchKeyword && !unitUpper.includes(searchKeyword)) return;

            if (!rekapKec[kec]) rekapKec[kec] = { total: 0 };
            rekapKec[kec].total += nilai;

            const key = `${unit}-${rekM}-${kodeAset}`;
            if (!grouped[key]) grouped[key] = { kec, unit, jenjang, rekM, kodeAset, total: 0 };
            grouped[key].total += nilai;
        });

        // Update Stats
        const tMesin = stats.sd_mesin + stats.smp_mesin;
        const tLain = stats.sd_lain + stats.smp_lain;
        document.getElementById("sd-mesin").innerText = `Rp ${formatIDR(stats.sd_mesin)}`;
        document.getElementById("sd-lain").innerText = `Rp ${formatIDR(stats.sd_lain)}`;
        document.getElementById("smp-mesin").innerText = `Rp ${formatIDR(stats.smp_mesin)}`;
        document.getElementById("smp-lain").innerText = `Rp ${formatIDR(stats.smp_lain)}`;
        document.getElementById("total-mesin").innerText = `Rp ${formatIDR(tMesin)}`;
        document.getElementById("total-lain").innerText = `Rp ${formatIDR(tLain)}`;
        document.getElementById("grand-total").innerText = `Rp ${formatIDR(tMesin + tLain)}`;

        filteredData = Object.values(grouped);
        const pageSize = isPrinting ? filteredData.length : rowLimit;
        const displayData = filteredData.slice((currentPage - 1) * pageSize, currentPage * pageSize);
        
        const tableBody = document.getElementById("main-table");
        tableBody.innerHTML = "";
        displayData.forEach((item, index) => {
            const rowNo = ((currentPage - 1) * pageSize + index + 1);
            tableBody.innerHTML += `
                <tr>
                    <td class="text-center small">${rowNo}</td>
                    <td><small>${item.kec}</small></td>
                    <td class="text-center"><span class="badge ${item.jenjang==='SD'?'badge-sd':'badge-smp'}">${item.jenjang}</span></td>
                    <td><div style="font-size: 0.85rem; font-weight: 600;">${item.unit}</div></td>
                    <td><small style="font-size: 0.75rem;">${item.rekM}</small></td>
                    <td class="hide-mobile text-center"><code>${item.kodeAset}</code></td>
                    <td class="text-end fw-bold text-primary">Rp ${formatIDR(item.total)}</td>
                </tr>`;
        });

        document.getElementById("pageInfo").innerText = `Hal ${currentPage} / ${Math.ceil(filteredData.length / pageSize) || 1}`;
        updateChart(Object.keys(rekapKec), Object.keys(rekapKec).map(k => rekapKec[k].total));
    }

    function updateChart(labels, values) {
        const ctx = document.getElementById('assetChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ data: values, backgroundColor: '#001f4d', borderRadius: 5 }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { legend: { display: false } },
                scales: { x: { ticks: { font: { size: 9 } } } }
            }
        });
    }

    function changePage(dir) {
        const pageSize = parseInt(document.getElementById("rowLimit").value);
        if ((currentPage + dir) > 0 && (currentPage + dir) <= Math.ceil(filteredData.length / pageSize)) {
            currentPage += dir; renderUI();
        }
    }

    function printToPDF() {
        isPrinting = true; renderUI(); 
        setTimeout(() => { window.print(); isPrinting = false; renderUI(); }, 500);
    }

    function exportToExcel() {
        XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById("targetTable")), "Monitoring_Aset_2026.xlsx");
    }

    window.onload = fetchData;
</script>
</body>
</html>
