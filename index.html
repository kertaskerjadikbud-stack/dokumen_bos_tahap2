<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Dokumen Pendukung Tahap 2 Dana BOS Tahun 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (max-width: 640px) {
      table { display: none; }
      .card-list { display: block; }
    }
    @media (min-width: 641px) {
      .card-list { display: none; }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-6">
  <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-center">Upload Dokumen Pendukung Tahap 2 Dana BOS Tahun 2025</h1>

  <!-- Container Data -->
  <div class="bg-white shadow-md rounded-lg p-4 sm:p-6 w-full overflow-x-auto">
    
    <!-- Info jumlah dokumen -->
    <p id="infoJumlah" class="mb-2 text-sm font-medium text-gray-700"></p>
    <div id="infoKecamatan" class="mb-4 text-sm text-gray-700 space-y-2"></div>

    <!-- Filter -->
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-2">
      <input type="text" id="searchBox" placeholder="Cari sekolah / jenjang / status..." 
        class="border rounded p-2 text-sm sm:text-base w-full sm:w-64" oninput="applyFilters()"/>
      
      <select id="filterKecamatan" onchange="applyFilters()" 
        class="border rounded p-2 text-sm sm:text-base w-full sm:w-64">
        <option value="">-- Semua Kecamatan --</option>
      </select>
    </div>

    <!-- Tabel Desktop -->
    <table class="table-auto w-full border-collapse border border-gray-300 text-sm sm:text-base">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Nama Satuan</th>
          <th class="border p-2">Jenjang</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Kecamatan</th>
          <th class="border p-2">Dokumen</th>
          <th class="border p-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="tabelData"></tbody>
    </table>

    <!-- Card List Mobile -->
    <div id="cardList" class="card-list space-y-4"></div>

    <!-- Pagination -->
    <div class="flex justify-center items-center gap-2 mt-4">
      <button id="prevBtn" onclick="prevPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Prev</button>
      <span id="pageInfo" class="text-sm"></span>
      <button id="nextBtn" onclick="nextPage()" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">Next</button>
    </div>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxTdF2J0mV-pmAIPjQO1O3zG1O9iEoHKH8Bw4RaqiZxgk8Z-7XDiDfYLewCJIIkpxVuPQ/exec";

// Pagination state
let allData = [];
let filteredData = [];
let currentPage = 1;
const rowsPerPage = 15;

// Convert file â†’ base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
    reader.readAsDataURL(file);
  });
}

// Load data awal
async function loadData() {
  try {
    const res = await fetch(`${WEB_APP_URL}?action=getAploudData`);
    allData = await res.json();
    filteredData = allData;

    // isi dropdown kecamatan (unik)
    const kecamatanSet = [...new Set(allData.map(d => d.kecamatan))].sort();
    const filterKecamatan = document.getElementById('filterKecamatan');
    filterKecamatan.innerHTML = '<option value="">-- Semua Kecamatan --</option>';
    kecamatanSet.forEach(kec => {
      const opt = document.createElement('option');
      opt.value = kec;
      opt.textContent = kec;
      filterKecamatan.appendChild(opt);
    });

    renderTable();
  } catch (err) {
    console.error("Gagal load data:", err);
  }
}

// Terapkan filter pencarian + kecamatan
function applyFilters() {
  const keyword = document.getElementById('searchBox').value.toLowerCase();
  const kecamatan = document.getElementById('filterKecamatan').value;

  filteredData = allData.filter(d => {
    const matchText = 
      d.namaSatuan.toLowerCase().includes(keyword) ||
      d.jenjang.toLowerCase().includes(keyword) ||
      d.status.toLowerCase().includes(keyword);

    const matchKec = kecamatan ? d.kecamatan === kecamatan : true;
    return matchText && matchKec;
  });

  currentPage = 1;
  renderTable();
}

// Render tabel & card dengan pagination
function renderTable() {
  const tabel = document.getElementById('tabelData');
  const cardList = document.getElementById('cardList');
  tabel.innerHTML = "";
  cardList.innerHTML = "";

  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const pageData = filteredData.slice(start, end);

  pageData.forEach(item => {
    const sudahUpload = item.dokumen && item.dokumen.startsWith("http");

    // baris tabel desktop
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border p-2">${item.namaSatuan}</td>
      <td class="border p-2">${item.jenjang}</td>
      <td class="border p-2">${item.status}</td>
      <td class="border p-2">${item.kecamatan}</td>
      <td class="border p-2 text-center">
        ${sudahUpload ? `<a href="${item.dokumen}" target="_blank" class="text-blue-600 underline">Lihat</a>` : "-"}
      </td>
      <td class="border p-2 text-center">
        <input type="file" id="file-${item.namaSatuan}" class="mb-2 text-xs" ${sudahUpload ? "disabled" : ""}/>
        <button onclick="uploadFileSekolah('${item.namaSatuan}')" 
          class="px-2 py-1 rounded text-xs ${sudahUpload ? 'bg-gray-400 cursor-not-allowed text-white' : 'bg-green-600 text-white hover:bg-green-700'}"
          ${sudahUpload ? "disabled" : ""}>
          Upload
        </button>
        <p id="status-${item.namaSatuan}" class="text-xs mt-1 text-gray-600">${sudahUpload ? "Sudah upload" : ""}</p>
      </td>
    `;
    tabel.appendChild(tr);

    // kartu mobile
    const card = document.createElement('div');
    card.className = "border rounded-lg p-3 shadow-sm";
    card.innerHTML = `
      <p class="font-semibold">${item.namaSatuan}</p>
      <p class="text-sm text-gray-600">Jenjang: ${item.jenjang}</p>
      <p class="text-sm text-gray-600">Status: ${item.status}</p>
      <p class="text-sm text-gray-600">Kecamatan: ${item.kecamatan}</p>
      <p class="mt-1">Dokumen: ${sudahUpload ? `<a href="${item.dokumen}" target="_blank" class="text-blue-600 underline">Lihat</a>` : "-"}</p>
      <div class="mt-2">
        <input type="file" id="file-${item.namaSatuan}" class="mb-2 text-xs block w-full" ${sudahUpload ? "disabled" : ""}/>
        <button onclick="uploadFileSekolah('${item.namaSatuan}')"
          class="px-3 py-1 rounded text-xs w-full ${sudahUpload ? 'bg-gray-400 cursor-not-allowed text-white' : 'bg-green-600 text-white hover:bg-green-700'}"
          ${sudahUpload ? "disabled" : ""}>
          Upload
        </button>
        <p id="status-${item.namaSatuan}" class="text-xs mt-1 text-gray-600">${sudahUpload ? "Sudah upload" : ""}</p>
      </div>
    `;
    cardList.appendChild(card);
  });

  // update info pagination
  const totalPages = Math.ceil(filteredData.length / rowsPerPage) || 1;
  document.getElementById('pageInfo').textContent = `Halaman ${currentPage} dari ${totalPages}`;
  document.getElementById('prevBtn').disabled = currentPage === 1;
  document.getElementById('nextBtn').disabled = currentPage === totalPages;

  // update jumlah dokumen terisi total
  const totalUpload = allData.filter(d => d.dokumen && d.dokumen.startsWith("http")).length;
  document.getElementById('infoJumlah').textContent = 
    `Jumlah dokumen terisi: ${totalUpload} dari ${allData.length} sekolah`;

  // hitung progres per kecamatan
  const kecamatanStat = {};
  allData.forEach(d => {
    if (!kecamatanStat[d.kecamatan]) kecamatanStat[d.kecamatan] = { total: 0, terisi: 0 };
    kecamatanStat[d.kecamatan].total++;
    if (d.dokumen && d.dokumen.startsWith("http")) kecamatanStat[d.kecamatan].terisi++;
  });

  // tampilkan rekap
  const infoKecamatanDiv = document.getElementById('infoKecamatan');
  infoKecamatanDiv.innerHTML = Object.keys(kecamatanStat).sort().map(kec => {
    const { total, terisi } = kecamatanStat[kec];
    const persen = Math.round((terisi / total) * 100);
    return `
      <div>
        <div class="flex justify-between items-center">
          <span class="font-semibold">${kec}</span>
          <span class="text-xs text-gray-600">${terisi} / ${total} (${persen}%)</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2 sm:h-3 mt-1">
          <div class="bg-green-600 h-2 sm:h-3 rounded-full transition-all" style="width:${persen}%;"></div>
        </div>
      </div>
    `;
  }).join("");
}

function prevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
function nextPage() { const totalPages = Math.ceil(filteredData.length / rowsPerPage); if (currentPage < totalPages) { currentPage++; renderTable(); } }

// Upload per sekolah
async function uploadFileSekolah(namaSatuan) {
  const fileInput = document.getElementById(`file-${namaSatuan}`);
  const status = document.getElementById(`status-${namaSatuan}`);
  if (!fileInput || !fileInput.files.length) { alert("Pilih file terlebih dahulu!"); return; }

  status.textContent = "Mengunggah...";
  try {
    const file = fileInput.files[0];
    const base64 = await fileToBase64(file);
    const payload = { action: "uploadFile", namaSatuan: namaSatuan, base64: base64.split(',')[1], mimeType: file.type };

    const res = await fetch(WEB_APP_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await res.json();

    if (result.success) {
      status.innerHTML = `Upload berhasil! <a href="${result.fileUrl}" target="_blank" class="text-blue-600 underline">Lihat file</a>`;
      fileInput.disabled = true; const btn = fileInput.nextElementSibling;
      btn.disabled = true; btn.className = "px-2 py-1 rounded text-xs bg-gray-400 cursor-not-allowed text-white";
      const satuanData = allData.find(d => d.namaSatuan === namaSatuan);
      if (satuanData) satuanData.dokumen = result.fileUrl;
      applyFilters();
    } else status.textContent = "Gagal upload: " + result.message;
  } catch (err) { console.error(err); status.textContent = "Terjadi kesalahan saat upload."; }
}

loadData();
</script>
</body>
</html>
