<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tahap II</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .navy-header { background-color: #001f3f !important; color: white !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* KUNCI HEADER (STICKY) */
        #mainTable thead {
            position: sticky;
            top: 0;
            z-index: 50;
        }

        #mainTable thead tr:first-child th {
            position: sticky;
            top: 0;
            z-index: 51;
            background-color: #001f3f !important;
        }

        #mainTable thead tr:last-child th {
            position: sticky;
            top: 38px; /* Menyesuaikan tinggi baris pertama agar tidak tumpang tindih */
            z-index: 50;
        }

        /* Memastikan border tetap terlihat saat sticky */
        th {
            box-shadow: inset 0 -1px 0 #334155, inset -1px 0 0 #334155;
        }
    </style>
</head>
<body class="p-4 md:p-6">

<div class="max-w-[98%] mx-auto">
    <div class="mb-6 text-center">
        <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-tight">ðŸ“Š Rekap Kertas Kerja Monitoring Penginputan Dana BOS Tahap II Tahun 2025</h1>
        <p class="text-slate-500 font-medium">DIKBUD - BPKAD (BIDANG ASET DAERAH) KABUPATEN DONGGALA</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-900">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Total Peralatan & Mesin</p>
            <h3 id="totalPeralatan" class="text-lg font-bold text-blue-900 mt-1">Rp 0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-700">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Total Aset Tetap Lainnya</p>
            <h3 id="totalAsetLain" class="text-lg font-bold text-blue-800 mt-1">Rp 0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-emerald-600">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Jumlah Total Keseluruhan</p>
            <h3 id="grandTotal" class="text-lg font-bold text-emerald-700 mt-1">Rp 0</h3>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-600">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">Total Selisih (Unbalanced)</p>
            <h3 id="totalSelisih" class="text-lg font-bold text-red-700 mt-1">Rp 0</h3>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex flex-wrap gap-3 flex-1 min-w-[300px]">
            <input type="text" id="searchInput" 
                class="flex-1 px-4 py-2 rounded-lg border border-slate-200 outline-none focus:ring-2 focus:ring-blue-900 transition-all text-sm" 
                placeholder="Cari sekolah/kecamatan..." onkeyup="updateTable()">
            <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all shadow-md">
                <span>ðŸ“„ Export PDF</span>
            </button>
        </div>
        <div class="flex items-center gap-4">
            <select id="pageSize" onchange="resetPage()" class="px-3 py-2 border border-slate-200 rounded-lg text-sm outline-none bg-slate-50">
                <option value="10">10 Baris</option>
                <option value="25" selected>25 Baris</option>
                <option value="50">50 Baris</option>
                <option value="500">Semua Data</option>
            </select>
            <span id="recordInfo" class="text-xs font-bold text-blue-900 bg-blue-50 px-3 py-2 rounded-lg border border-blue-100 italic">Memuat...</span>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
        <div id="loader" class="p-20 text-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-900 mx-auto mb-4"></div>
            <p class="text-slate-500 text-sm">Menampilkan Data...</p>
        </div>

        <div id="content" style="display:none;">
            <div class="overflow-x-auto overflow-y-auto max-h-[600px] custom-scrollbar">
                <table class="w-full text-[11px] border-separate border-spacing-0" id="mainTable">
                    <thead>
                        <tr class="navy-header text-center uppercase">
                            <th colspan="2" class="px-4 py-3 border-b border-r border-slate-700">Identitas Sekolah</th>
                            <th colspan="3" class="px-4 py-3 border-b border-r border-slate-700">KERTAS KERJA HASIL REKON DINAS PENIDIKAN DAN KEBUDAYAAN</th>
                            <th colspan="3" class="px-4 py-3 border-b border-r border-slate-700">KERTAS KERJA PENGINPUTAN SEKOLAH</th>
                            <th class="px-4 py-3 border-b border-r border-slate-700">SELISIH KK DIKJAR/KK SEKOLAH</th>
                            <th colspan="3" class="px-4 py-3 border-b border-slate-700">KERTAS KERJA PENGINPUTAN E-BMD</th>
                        </tr>
                        <tr class="bg-slate-200 text-slate-800 font-bold uppercase text-center">
                            <th class="px-2 py-2 border-b border-r border-slate-300">Kecamatan</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">Nama Sekolah</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">PERALATAN DAN MESIN</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">ASET TETAP LAIN</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300 bg-blue-100">Total</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">PERALATAN DAN MESIN</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">ASET TETAP LAIN</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300 bg-indigo-100">Total</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300 text-red-700">Selisih</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">PERALATAN DAN MESIN</th>
                            <th class="px-2 py-2 border-b border-r border-slate-300">ASET TETAP LAIN</th>
                            <th class="px-2 py-2 border-b border-slate-300 bg-emerald-100">Total</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100 italic"></tbody>
                </table>
            </div>
            
            <div class="p-4 flex flex-col md:flex-row items-center justify-between gap-4 bg-slate-50 border-t border-slate-100">
                <div id="paginationInfo" class="text-xs text-slate-500 font-medium"></div>
                <div id="paginationControls" class="flex items-center gap-1"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwk0ZV-Qc3scfY5eRMLE4dBRde3Jwu6iTZ41R2yL07qcAft8_qQMdNja1ALSp6oSnb8/exec";
    let fullData = [];
    let currentPage = 1;
    let pageSize = 25;

    function formatRupiah(val) {
        const num = parseFloat(val);
        if (isNaN(num) || num === 0) return "Rp 0";
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
    }

    async function loadData() {
        const loader = document.getElementById('loader');
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            fullData = data.slice(4).filter(row => row[1] && row[1].toString().trim() !== "");

            let sumPeralatan = 0, sumAsetLain = 0, sumGrand = 0, sumSelisih = 0;
            fullData.forEach(row => {
                const namaSekolah = (row[1] || "").toString().toUpperCase();
                if (!namaSekolah.includes("TOTAL") && !namaSekolah.includes("JUMLAH")) {
                    sumPeralatan += parseFloat(row[2]) || 0;
                    sumAsetLain += parseFloat(row[3]) || 0;
                    sumGrand += parseFloat(row[4]) || 0;
                    sumSelisih += parseFloat(row[8]) || 0;
                }
            });

            document.getElementById('totalPeralatan').innerText = formatRupiah(sumPeralatan);
            document.getElementById('totalAsetLain').innerText = formatRupiah(sumAsetLain);
            document.getElementById('grandTotal').innerText = formatRupiah(sumGrand);
            document.getElementById('totalSelisih').innerText = formatRupiah(sumSelisih);

            updateTable();
            loader.classList.add('hidden');
            document.getElementById('content').style.display = 'block';
        } catch (e) {
            console.error(e);
            loader.innerHTML = `<p class="text-red-500 font-bold">Error: ${e.message}</p>`;
        }
    }

    function updateTable() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = fullData.filter(row => row.slice(0, 2).join(' ').toLowerCase().includes(query));
        const totalPages = Math.ceil(filtered.length / pageSize);
        if (currentPage > totalPages) currentPage = 1;

        const start = (currentPage - 1) * pageSize;
        const paginated = filtered.slice(start, start + pageSize);

        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        paginated.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = "hover:bg-blue-50/50 transition-colors bg-white";
            
            for (let i = 0; i < 12; i++) {
                const td = document.createElement('td');
                const val = row[i];
                td.className = "px-2 py-2 border-b border-r border-slate-100 whitespace-nowrap";

                if (i >= 2 && !isNaN(parseFloat(val))) {
                    td.innerText = formatRupiah(val);
                    td.classList.add("text-right", "font-mono", "not-italic");
                    if (i === 8 && parseFloat(val) !== 0) td.classList.add("text-red-700", "font-bold", "bg-red-50");
                    if (i === 4 || i === 7 || i === 11) td.classList.add("bg-slate-50", "font-bold");
                } else {
                    td.innerText = val || "-";
                    if(i === 1) td.classList.add("font-bold", "text-slate-700", "not-italic");
                    if(i === 0) td.classList.add("text-center", "not-italic", "text-slate-400");
                }
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });

        renderPagination(filtered.length);
        document.getElementById('recordInfo').innerText = `TOTAL: ${filtered.length} BARIS`;
        document.getElementById('paginationInfo').innerText = `Menampilkan ${start + 1} sampai ${Math.min(start + pageSize, filtered.length)} dari ${filtered.length} data`;
    }

    function renderPagination(totalCount) {
        const pages = Math.ceil(totalCount / pageSize);
        const ctrl = document.getElementById('paginationControls');
        ctrl.innerHTML = "";
        if (pages <= 1) return;

        const prevBtn = document.createElement('button');
        prevBtn.innerText = "â€¹";
        prevBtn.className = `px-3 py-1 rounded font-bold ${currentPage === 1 ? 'text-slate-300' : 'text-blue-900 hover:bg-blue-100'}`;
        prevBtn.onclick = () => { if(currentPage > 1) { currentPage--; updateTable(); scrollTableTop(); } };
        ctrl.appendChild(prevBtn);

        for (let i = 1; i <= pages; i++) {
            if (i === 1 || i === pages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                const btn = document.createElement('button');
                btn.innerText = i;
                btn.onclick = () => { currentPage = i; updateTable(); scrollTableTop(); };
                btn.className = `px-3 py-1 rounded text-[10px] font-bold transition-all ${
                    i === currentPage ? 'bg-blue-900 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                }`;
                ctrl.appendChild(btn);
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                const dot = document.createElement('span');
                dot.innerText = "...";
                dot.className = "px-1 text-slate-400";
                ctrl.appendChild(dot);
            }
        }

        const nextBtn = document.createElement('button');
        nextBtn.innerText = "â€º";
        nextBtn.className = `px-3 py-1 rounded font-bold ${currentPage === pages ? 'text-slate-300' : 'text-blue-900 hover:bg-blue-100'}`;
        nextBtn.onclick = () => { if(currentPage < pages) { currentPage++; updateTable(); scrollTableTop(); } };
        ctrl.appendChild(nextBtn);
    }

    function scrollTableTop() {
        document.querySelector('.overflow-y-auto').scrollTop = 0;
    }

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.setFontSize(14);
        doc.text("LAPORAN MONITORING PENGINPUTAN DANA BOS TAHAP II TAHUN 2025 BIDANG ASET DAERAH", 14, 15);
        doc.autoTable({
            html: '#mainTable',
            startY: 25,
            theme: 'grid',
            headStyles: { fillColor: [0, 31, 63], textColor: [255, 255, 255], fontSize: 7, halign: 'center' },
            styles: { fontSize: 6, cellPadding: 2 }
        });
        doc.save("Monitoring_Tahap_II.pdf");
    }

    function resetPage() { 
        pageSize = parseInt(document.getElementById('pageSize').value); 
        currentPage = 1; 
        updateTable(); 
    }

    loadData();
</script>
</body>
</html>
