<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Aset BOS & E-BMD - Kabupaten Donggala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .navy-header { background-color: #001f3f !important; color: white !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .sticky-header thead { position: sticky; top: 0; z-index: 50; }
        #mainTable thead th { font-size: 10px; padding: 10px 4px; border: 1px solid #1e293b; }
        #mainTable tbody td { font-size: 11px; padding: 6px 4px; border: 1px solid #e2e8f0; }
        canvas { max-height: 180px; }
        @media print { .no-print { display: none; } }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body class="p-4 md:p-6">

<div id="loader" class="loading-overlay">
    <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-4 border-blue-600 mb-2"></div>
        <p class="font-bold text-slate-700">Memuat Data...</p>
    </div>
</div>

<div class="max-w-[99%] mx-auto">
    <div class="mb-6 text-center">
        <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-tight">üìä Monitoring Progres Penginputan Belanja Modal BOS 2025</h1>
        <p class="text-slate-500 font-medium italic underline">DINAS PENDIDIKAN DAN KEBUDAYAAN</p>
        <p class="text-slate-500 font-medium italic underline text-xs">KABUPATEN DONGGALA</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 no-print">
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <h4 class="text-xs font-bold text-slate-600 uppercase mb-4 text-center">Progres Penginputan</h4>
            <canvas id="chartInput"></canvas>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <h4 class="text-xs font-bold text-slate-600 uppercase mb-4 text-center">Status Validitas Data (Jumlah Total)</h4>
            <canvas id="chartBalance"></canvas>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6 no-print">
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
            <p class="text-[10px] font-bold text-slate-500 uppercase">Total Peralatan Dan Mesin</p>
            <h3 id="statPeralatan" class="text-sm font-bold text-blue-700">Rp 0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-teal-500">
            <p class="text-[10px] font-bold text-slate-500 uppercase">Total Aset Tetap Lain</p>
            <h3 id="statAsetLain" class="text-sm font-bold text-teal-700">Rp 0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-slate-800">
            <p class="text-[10px] font-bold text-slate-500 uppercase">Jumlah Total Rekon</p>
            <h3 id="statGrandTotal" class="text-sm font-bold text-slate-900">Rp 0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-600">
            <p class="text-[10px] font-bold text-red-600 uppercase">Total Selisih</p>
            <h3 id="statTotalSelisih" class="text-sm font-bold text-red-600">Rp 0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
            <p class="text-[10px] font-bold text-emerald-600 uppercase">Info Sekolah</p>
            <div class="text-[11px] leading-tight mt-1">
                <span>Input: <b id="countDone" class="text-emerald-700">0</b></span> | 
                <span>Sisa: <b id="countPending" class="text-red-600">0</b></span>
            </div>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-between border border-slate-200 no-print">
        <div class="flex flex-wrap gap-3 flex-1 min-w-[300px]">
            <input type="text" id="searchInput" class="flex-1 px-4 py-2 rounded-lg border border-slate-200 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cari sekolah atau kecamatan..." onkeyup="updateTable()">
            <select id="filterStatus" onchange="updateTable()" class="px-4 py-2 rounded-lg border border-slate-200 text-sm font-bold bg-slate-50">
                <option value="all">üîç Semua Data</option>
                <option value="selisih">‚ùå Data Selisih</option>
                <option value="sudah_input">‚úÖ Sudah Input</option>
                <option value="belum_input">‚ö†Ô∏è Belum Input</option>
            </select>
        </div>
        <div class="flex gap-2">
            <button onclick="exportExcel()" class="bg-emerald-600 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition">Excel</button>
            <button onclick="exportPDF()" class="bg-red-600 text-white px-5 py-2 rounded-lg text-xs font-bold hover:bg-red-700 transition">PDF</button>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto overflow-y-auto max-h-[600px] custom-scrollbar sticky-header">
            <table class="w-full border-separate border-spacing-0" id="mainTable">
                <thead>
                    <tr class="navy-header text-center uppercase">
                        <th rowspan="2" class="border-r border-slate-700">No</th>
                        <th rowspan="2" class="border-r border-slate-700">Kecamatan</th>
                        <th rowspan="2" class="border-r border-slate-700">Nama Sekolah</th>
                        <th colspan="3" class="bg-blue-800 border-r border-slate-700">1. Kertas Kerja Rekon Dinas</th>
                        <th colspan="3" class="bg-teal-700 border-r border-slate-700">2. Input Kertas Kerja Sekolah</th>
                        <th colspan="3" class="bg-orange-700 border-r border-slate-700">3.Input Belanja Modal Ke E-BMD</th>
                        <th rowspan="2" class="bg-red-900">SELISIH</th>
                    </tr>
                    <tr class="bg-slate-200 text-slate-800 font-bold text-center">
                        <th>Peralatan dan Mesin</th><th>Aset Tetap Lain</th><th class="bg-blue-100">Total</th>
                        <th>Peralatan dan Mesin</th><th>Aset Tetap Lain</th><th class="bg-teal-100">Total</th>
                        <th>Peralatan dan Mesin</th><th>Aset Tetap Lain</th><th class="bg-orange-100">Total</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwk0ZV-Qc3scfY5eRMLE4dBRde3Jwu6iTZ41R2yL07qcAft8_qQMdNja1ALSp6oSnb8/exec";
    let masterData = [];
    let chartInput, chartBalance;

    function formatRupiah(val) {
        const num = parseFloat(val) || 0;
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
    }

    function initCharts() {
        const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } };
        
        chartInput = new Chart(document.getElementById('chartInput'), { 
            type: 'doughnut', 
            data: { labels: ['Sudah','Belum'], datasets: [{ data: [0, 0], backgroundColor: ['#10b981', '#f87171'] }] },
            options: options 
        });

        chartBalance = new Chart(document.getElementById('chartBalance'), { 
            type: 'pie', 
            data: { labels: ['Balance','Selisih'], datasets: [{ data: [0, 0], backgroundColor: ['#3b82f6', '#ef4444'] }] },
            options: options 
        });
    }

    async function loadData() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            // Validasi data (asumsi baris 0-3 adalah header di Google Sheets)
            masterData = data.slice(4).filter(row => row[1] && row[1].toString().trim() !== "");
            
            document.getElementById('loader').style.display = 'none';
            initCharts();
            updateTable();
        } catch (e) {
            console.error("Gagal memuat data:", e);
            alert("Gagal mengambil data dari server.");
        }
    }

    function getSyncedRow(row) {
        // Mapping Index: 0:Kec, 1:Sekolah, 2:PeralatanRekon, 3:LainRekon, 4:TotalRekon
        // 5:PeralatanSek, 6:LainSek, 7:TotalSek, 8:PeralatanEBMD, 9:LainEBMD, 10:TotalEBMD, 11:Selisih
        const rekonP = parseFloat(row[2]) || 0;
        const rekonL = parseFloat(row[3]) || 0;
        const totalSek = parseFloat(row[7]) || 0;
        const totalEBMD = parseFloat(row[10]) || 0;

        let sekP = 0, sekL = 0, ebmdP = 0, ebmdL = 0;

        // Logika Distribusi Kertas Kerja
        if (rekonP > 0 && rekonL === 0) { sekP = totalSek; sekL = 0; }
        else if (rekonL > 0 && rekonP === 0) { sekP = 0; sekL = totalSek; }
        else { sekP = parseFloat(row[5]) || 0; sekL = parseFloat(row[6]) || 0; }

        // Logika Distribusi E-BMD
        if (totalEBMD > 0) {
            if (rekonP > 0 && rekonL === 0) { ebmdP = totalEBMD; ebmdL = 0; }
            else if (rekonL > 0 && rekonP === 0) { ebmdP = 0; ebmdL = totalEBMD; }
            else { ebmdP = parseFloat(row[8]) || 0; ebmdL = parseFloat(row[9]) || 0; }
        }

        return { sekP, sekL, totalSek, ebmdP, ebmdL, totalEBMD };
    }

    function updateTable() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('filterStatus').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";

        let sPer = 0, sLain = 0, sGrand = 0, sSel = 0, cDone = 0, cBal = 0;

        const filtered = masterData.filter(row => {
            const textMatch = (row[0] + ' ' + row[1]).toLowerCase().includes(query);
            const totalSek = parseFloat(row[7]) || 0;
            const selisih = Math.abs(parseFloat(row[11]) || 0);

            if (status === 'selisih') return textMatch && selisih > 1;
            if (status === 'sudah_input') return textMatch && totalSek > 0;
            if (status === 'belum_input') return textMatch && totalSek <= 0;
            return textMatch;
        });

        filtered.forEach((row, index) => {
            const sync = getSyncedRow(row);
            const selisihVal = parseFloat(row[11]) || 0;

            // Stats accumulator
            sPer += parseFloat(row[2]) || 0;
            sLain += parseFloat(row[3]) || 0;
            sGrand += parseFloat(row[4]) || 0;
            sSel += selisihVal;
            if (sync.totalSek > 0) cDone++;
            if (Math.abs(selisihVal) < 1) cBal++;

            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-50 transition-colors";
            
            const cellValues = [
                index + 1, row[0], row[1],
                row[2], row[3], row[4],
                sync.sekP, sync.sekL, sync.totalSek,
                sync.ebmdP, sync.ebmdL, sync.totalEBMD,
                row[11]
            ];

            cellValues.forEach((val, i) => {
                const td = document.createElement('td');
                if (i > 2) {
                    td.innerText = formatRupiah(val);
                    td.className = "text-right font-mono border-r";
                    if (i === 12) {
                        td.className += " font-bold " + (Math.abs(val) > 1 ? "text-red-600 bg-red-50" : "text-emerald-600 bg-emerald-50");
                    }
                } else {
                    td.innerText = val;
                    td.className = "border-r px-2";
                }
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        // Update Stats UI
        document.getElementById('statPeralatan').innerText = formatRupiah(sPer);
        document.getElementById('statAsetLain').innerText = formatRupiah(sLain);
        document.getElementById('statGrandTotal').innerText = formatRupiah(sGrand);
        document.getElementById('statTotalSelisih').innerText = formatRupiah(sSel);
        document.getElementById('countDone').innerText = cDone;
        document.getElementById('countPending').innerText = filtered.length - cDone;

        // Update Charts
        if(chartInput) {
            chartInput.data.datasets[0].data = [cDone, filtered.length - cDone];
            chartInput.update();
        }
        if(chartBalance) {
            chartBalance.data.datasets[0].data = [cBal, filtered.length - cBal];
            chartBalance.update();
        }
    }

    function exportExcel() {
        const table = document.getElementById("mainTable");
        const wb = XLSX.utils.table_to_book(table, { sheet: "Monitoring_BOS" });
        XLSX.writeFile(wb, "Laporan_Monitoring_BOS_2025.xlsx");
    }

   async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const now = new Date();
        const optionsDate = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', timeZoneName: 'short' };
        const timeStampStr = now.toLocaleString('id-ID', optionsDate);

        // --- KOP SURAT (SESUAI STANDAR PERSURATAN) ---
        const logoUrl = "https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png";
        
        try {
            // Posisi logo di sebelah kiri teks utama
            doc.addImage(logoUrl, 'PNG', 25, 7, 15, 18);
        } catch (e) {
            console.error("Gagal memuat logo:", e);
        }

        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text("PEMERINTAH KABUPATEN DONGGALA", pageWidth / 2 + 10, 12, { align: "center" });
        
        doc.setFontSize(13);
        doc.text("DINAS PENDIDIKAN DAN KEBUDAYAAN", pageWidth / 2 + 10, 18, { align: "center" });
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "normal");
        doc.text("Kompleks Perkantoran Gunung Bale, Kabupaten Donggala, Sulawesi Tengah", pageWidth / 2 + 10, 23, { align: "center" });
        
        // Garis Pembatas Kop (Double Line)
        doc.setLineWidth(0.8);
        doc.line(15, 27, pageWidth - 15, 27);
        doc.setLineWidth(0.2);
        doc.line(15, 28, pageWidth - 15, 28);

        // --- JUDUL LAPORAN (DI BAWAH GARIS) ---
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.text("LAPORAN MONITORING BELANJA MODAL BOS 2025", pageWidth / 2, 36, { align: "center" });

        // --- RINGKASAN DATA ---
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        const sPer = document.getElementById('statPeralatan').innerText;
        const sLain = document.getElementById('statAsetLain').innerText;
        const sGrand = document.getElementById('statGrandTotal').innerText;
        const sSel = document.getElementById('statTotalSelisih').innerText;
        const sDone = document.getElementById('countDone').innerText;
        const sPend = document.getElementById('countPending').innerText;

        doc.text(`Total Peralatan: ${sPer}`, 15, 43);
        doc.text(`Total Aset Lainnya: ${sLain}`, 80, 43);
        doc.text(`Grand Total Rekon: ${sGrand}`, 150, 43);
        doc.text(`Total Selisih: ${sSel}`, 15, 48);
        doc.text(`Status Sekolah: Sudah Input (${sDone}) | Belum (${sPend})`, 80, 48);
        doc.setFont("helvetica", "italic");
        doc.text(`Waktu Cetak: ${timeStampStr}`, pageWidth - 15, 48, { align: 'right' });

        // --- TABEL DATA ---
        doc.autoTable({ 
            html: '#mainTable', 
            startY: 53, 
            theme: 'grid',
            styles: { fontSize: 6, cellPadding: 1.2, valign: 'middle', halign: 'center' },
            headStyles: { fillColor: [0, 31, 63], textColor: [255, 255, 255], fontStyle: 'bold' },
            columnStyles: {
                0: { cellWidth: 7 }, 1: { cellWidth: 20 },
                2: { cellWidth: 'auto', halign: 'left' },
                3: { cellWidth: 21, halign: 'right' }, 4: { cellWidth: 21, halign: 'right' }, 5: { cellWidth: 21, halign: 'right' },
                6: { cellWidth: 21, halign: 'right' }, 7: { cellWidth: 21, halign: 'right' }, 8: { cellWidth: 21, halign: 'right' },
                9: { cellWidth: 21, halign: 'right' }, 10: { cellWidth: 21, halign: 'right' }, 11: { cellWidth: 21, halign: 'right' },
                12: { cellWidth: 20, fontStyle: 'bold' }
            }
        });

        // --- AREA TANDA TANGAN (DENGAN NIP) ---
        let finalY = doc.lastAutoTable.finalY + 12;
        if (finalY > pageHeight - 50) { doc.addPage(); finalY = 25; }

        const colWidth = (pageWidth - 30) / 3;
        doc.setFontSize(8);
        doc.setFont("helvetica", "bold");
        doc.text("Pengelola Dana BOS,", 15 + (colWidth / 2), finalY, { align: "center" });
        doc.text("Pengurus Barang Disdikbud,", 15 + colWidth + (colWidth / 2), finalY, { align: "center" });
        doc.text("Tim Verifikasi Aset,", 15 + (colWidth * 2) + (colWidth / 2), finalY, { align: "center" });

        // Tempat tanda tangan (Kosong)
        doc.setFont("helvetica", "normal");
        doc.text("( TAUHID )", 15 + (colWidth / 2), finalY + 22, { align: "center" });
        doc.text("( MA'RUF )", 15 + colWidth + (colWidth / 2), finalY + 22, { align: "center" });
        doc.text("( MUHAMMAD KAUTSAR HASAN, S.M. )", 15 + (colWidth * 2) + (colWidth / 2), finalY + 22, { align: "center" });

        // Baris NIP
        doc.text("NIP. 198506262009031003", 15 + (colWidth / 2), finalY + 27, { align: "center" });
        doc.text("NIP. 198306262014091001", 15 + colWidth + (colWidth / 2), finalY + 27, { align: "center" });
        doc.text("NIP. 199306122025211151", 15 + (colWidth * 2) + (colWidth / 2), finalY + 27, { align: "center" });

        // Footer Halaman
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(7);
            doc.text(`Halaman ${i} dari ${totalPages} | Sistem Monitoring Aset BOS Donggala`, pageWidth / 2, pageHeight - 5, { align: 'center' });
        }

        doc.save(`Laporan_BOS_Donggala_${now.getTime()}.pdf`);
    }

    window.onload = loadData;
</script>

</body>
</html>
